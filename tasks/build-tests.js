'use strict';

const del = require('del');
const gulp = require('gulp');
const jetpack = require('fs-jetpack');
const bundle = require('./bundle');
const istanbul = require('rollup-plugin-istanbul');

const destDir = jetpack.cwd('test');
const srcDir = jetpack.cwd('src');

const fileBanner = "// This file is generated automatically.\n"
    + "// All modifications will be lost.\n\n";

// Spec files are scattered through the whole project. Here we're searching
// for them and generate one entry file which will run all the tests.
const generateEntryFile = (dir, destFileName, filePattern) =>
    dir.findAsync('.', { matching: filePattern })
    .then((specPaths) =>
        specPaths.length
            ? dir.writeAsync(
                destFileName,
                fileBanner + specPaths.map((path) => 'import "./' + path.replace(/\\/g, '/') + '";').join('\n')
            )
            : null
    )
    .then((result) => result ? dir.path(destFileName) : null);

gulp.task('build-unit', () =>
    generateEntryFile(srcDir, 'specs.js.autogenerated', '*.spec.js')
    .then((entryFilePath) =>
        entryFilePath ? bundle(entryFilePath, destDir.path('specs.js.autogenerated'), {
            rollupPlugins: [
                istanbul({
                    exclude: ['**/*.spec.js', '**/specs.js.autogenerated'],
                    sourceMap: true
                })
            ]
        }) : null
    )
);
